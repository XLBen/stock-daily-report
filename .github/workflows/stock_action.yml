name: Quant Monitor (Heartbeat)

on:
  schedule:
    # æ ¸å¿ƒæ”¹åŠ¨ï¼šå‘¨ä¸€åˆ°å‘¨äº”ï¼Œæ¯ 20 åˆ†é’Ÿè¿è¡Œä¸€æ¬¡
    # æ³¨æ„ï¼šPython è„šæœ¬å†…éƒ¨ä¼šå†æ¬¡åˆ¤æ–­æ˜¯å¦æ˜¯ç¾è‚¡ç›˜ä¸­ï¼Œä¸åœ¨ç›˜ä¸­ä¼šç›´æ¥é€€å‡ºï¼Œä¸è€—èµ„æº
    - cron: '*/20 * * * 1-5'
  
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

# æ ¸å¿ƒæ”¹åŠ¨ï¼šèµ‹äºˆ Actions å†™æƒé™ï¼Œå…è®¸å®ƒæäº¤æ•°æ®åº“æ–‡ä»¶
permissions:
  contents: write

jobs:
  monitor:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run Monitor Engine
        env:
          MAIL_USER: ${{ secrets.MAIL_USER }}
          MAIL_PASS: ${{ secrets.MAIL_PASS }}
          MAIL_RECEIVER: ${{ secrets.MAIL_RECEIVER }}
          LLM_API_KEY: ${{ secrets.LLM_API_KEY }}
          LLM_BASE_URL: ${{ secrets.LLM_BASE_URL }}
        run: python main.py

      # æ ¸å¿ƒæ”¹åŠ¨ï¼šå¦‚æœæ•°æ®åº“å˜äº†ï¼Œæäº¤å›ä»“åº“
      - name: Commit State Database
        run: |
          git config --global user.name 'QuantBot'
          git config --global user.email 'bot@noreply.github.com'
          
          # æ£€æŸ¥æ•°æ®åº“æ–‡ä»¶æ˜¯å¦æœ‰å˜åŠ¨
          if [[ -n $(git status -s quant_state.db) ]]; then
            echo "ğŸ’¾ Detected state change, saving database..."
            git add quant_state.db
            git commit -m "Auto-save: Update quant state [skip ci]"
            git push
          else
            echo "ğŸ’¤ No state change, skipping save."
          fi